
<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>COOPERVISION - Simulateur CA contactologie</title>
  <style>
      :root { --bg:#f7f8fa; --banner-bg:#0f172a; --banner-fg:#ffffff; --card-bg:#ffffff; --card-border:#e5e7eb; --accent:#2563eb; --muted:#6b7280; }
      *{ box-sizing:border-box; }
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif; background:var(--bg); color:#111827; }
      header{ background:linear-gradient(90deg,#0f172a,#1e3a8a); color:var(--banner-fg); padding:18px 24px; border-bottom:4px solid #2563eb; position:sticky; top:0; z-index:10; }
      header h1{ margin:0; font-size:1.25rem; letter-spacing:0.2px; }
      label { font-weight: 600; color: #333; }
      input[type="text"], input[type="number"]{ width:100%; padding:8px 10px; border:1px solid var(--card-border); border-radius:6px; outline:none; }
      input[type="text"]:focus, input[type="number"]:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,0.35); }
      h2{ margin:0 0 12px 0; text-align: left; font-size:1rem; color:#111827;}
      .container{ display:flex; gap:16px; padding:16px; align-items:stretch; }
      .panel{ background:var(--card-bg); border:1px solid var(--card-border); border-radius:10px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,0.06),0 1px 2px rgba(0,0,0,0.04); }
      .left{ flex:1 1 30%; min-width:380px; }
      .right{ flex:1 1 70%; min-width:420px; }
      .form-row{ display:grid; grid-template-columns: 1fr 160px; gap:8px; margin-bottom:12x; }
      .form-row.readonly input{ background:#f8fafc; color:#6b7280; }
      .toolbar{ display:flex; gap:10px; margin-top:50px; flex-wrap:wrap; align-items:center; text-align:center;}
      .toolbar .grow{ flex:1; }
      button{ padding:8px 12px; border:1px solid var(--card-border); border-radius:8px; background:#f3f4f6; cursor:pointer; font-weight:600; width: 100% }
      button.primary { background: #005FB8; color:#fff; border-color: var(--primary); }
      button.danger{ background:#ef4444; color:white; border-color:#dc2626; }
      button.neutral{ background:#e5e7eb; color:#111827; }
      button:hover { background:#BFBFBF; }
      .hint{ font-size:0.85rem; color:var(--muted); margin-top:6px; }
      #chartWrapper{ width:100%; position:relative; height:500px; }
      #chart{ height:100%; border-radius:8px; background:#ffffff; }
      .legend{ display:flex; flex-wrap:wrap; gap:8px 12px; margin-top:10px; color:var(--muted); font-size:0.9rem; }
      .legend .item{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px dashed var(--card-border); border-radius:6px; background:#f8fafc; }
      .legend .swatch{ width:14px; height:14px; border-radius:3px; display:inline-block; }
      @media (max-width:900px){ .container{ flex-direction:column; } .left,.right{ min-width:100%; } }
      .ligne-champ {display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 16px; }
      .ligne-champ label {min-width: 200px; font-weight: 600;font-size: 16px; }
      .ligne-champ input {flex: 1; padding: 6px 8px;font-size: 10px; }
      .blinkable input { order: 2px solid #ccc;transition: background-color 0.2s, border-color 0.2s;}
      /* en tete + image */ 
      header .header-content { display:flex; align-items:center; gap:12px; flex-wrap:nowrap; }
      header .header-content .logo { height:auto; width:auto; max-height:48px; max-width:160px; }
      @media (max-width: 600px) {header .header-content .logo { max-height:36px; max-width:120px; } header .header-content h1 { font-size:1rem; } }
  /* Colonne droite = nouvelle section a droite */
      aside {flex: 0 0 180px; border-left: 1px solid #e5e7eb; padding-left: 16px; text-align:center; }
      .right-card {background: #ffffff;border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;height: 580px; }
      .right-card h3 {margin: 0 0 8px 0; font-size: 18px; font-weight: 800; color: #374151; }
      .right-card img { display: block; width: 100%; height: auto; border-radius: 6px; }

      /* En-tête et sections à gauche */
      header h1 {margin: 0 0 4px 0; font-size: 1.5rem; }
      header p { margin: 0 0 16px 0; color: #6b7280; }
      section { margin-bottom: 24px; }
      h2, h3 { margin-top: 0; text-align: center;}
      #EvoCaLentilles { font-size: 18px; }
      #EvoCaGlobal { font-size: 18px; }
    .hidden { display: none; }

      /*Animation reset data */
      .reset-anim { animation: resetFlash 0.4s ease-out; } @keyframes resetFlash { 0% { background-color: rgba(255, 0, 0, 0.15); } 100% { background-color: transparent; } }
      .blink { animation: blink-red 0.4s linear 3;}
    @keyframes blink-red {0%, 100% {background-color: white; border-color: red; } 50% {background-color: red; border-color: darkred; } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>

<body>
  <header>
    <div class="header-content">
    <img alt="CooperVision" class="logo" src="logo.png"/>
    <h1>COOPERVISION - Simulateur CA contactologie</h1>
    </div>
  </header>

<div id="print-area">
  <div class="container">

    <section class="panel left">
      <h2>Données client</h2>
      <div id="rows">
        <div class="ligne-champ">
          <label for="caGlobalActuel">CA Global - Actuel (€)</label>
          <input id="caGlobalActuel" min="0" placeholder="Saisir une valeur" required step="1000" type="number"/>
        </div>

        <div class="ligne-champ">
          <label for="caLentillesActuel">CA Lentilles - Actuel (€)</label>
          <input id="caLentillesActuel" min="0" placeholder="Saisir une valeur" required step="1000" type="number"/>
        </div>

        <div class="ligne-champ">
          <label for="objectifPct">Objectif contactologie (%)</label>
          <input id="objectifPct" max="30" min="0" placeholder="Entrer un pourcentage" step="1" type="number"/>
        </div>

        <div class="ligne-champ">
          <label for="caGlobalProjete">CA Global - Projeté (€)</label>
          <input disabled id="caGlobalProjete" placeholder="Calcul automatique" type="text"/>
        </div>

        <div class="ligne-champ">
          <label for="caLentillesProjete">CA Lentilles - Projeté (€)</label>
          <input disabled id="caLentillesProjete" placeholder="Calcul automatique" type="text"/>
        </div>

        <div class="toolbar">
          <button class="hidden" id="btnUpdate">Actualiser les donnees</button> 
          <button class="primary" id="btnSaveBar">Enregistrer le graphique en local</button>
          <button class="primary" id="btnMail">Envoyer par mail</button>
          <button class="danger" id="clearBtn">Tout effacer</button>
        </div>
      </div>
    </section>

    <section class="panel right">
      <h3>Evolution du Chiffre d'Affaires</h3>
      <div id="chartWrapper">
        <canvas id="chart"></canvas>
      </div>
      <img id="img2" src="image2.png" class="hidden"
      style="position:absolute;top:250px;left:50%;width:160px;height:auto;pointer-events:none;opacity:0.8;">
    </section>

    <aside>
      <div class="right-card">
        <img alt="CooperVision" class="promo" src="image1.png"/>
        <p style="text-align:center;color:rgba(255,82,14,0.8);font-weight:bold;">
          CA Lentilles
          <input type="text" id="EvoCaLentilles" disabled
          style="font-weight:bold;text-align:right;border:3px solid rgba(255,82,14,0.8);border-radius:8px;background:rgba(255,127,14,0.80);">
        </p>

        <p style="text-align:center;color:rgba(18,43,182,0.6);font-weight:bold;">
          CA Total
          <input type="text" id="EvoCaGlobal" disabled
          style="font-weight:bold;text-align:right;border:3px solid rgba(18,43,182,0.6);border-radius:8px;background:rgba(31,119,180,0.60);">
        </p>
      </div>
    </aside>

  </div> <!-- fin container -->
</div>   <!-- fin print-area -->


<!-- *********************************************************************************** -->
<script>

    const val = (id) => {
      const el = document.getElementById(id);
      const v = parseFloat((el.value || "").replace(",", "."));
      return isNaN(v) ? null : v;
     };
    const setVal = (id, v) => {
      const el = document.getElementById(id);
      el.value = (v ?? "").toString();
     };

    // Register plugin
     Chart.register(ChartDataLabels);


    //*******************************************************************
    //Bouton effacer
      document.getElementById('clearBtn').addEventListener('click', () => {
      const inputs = document.querySelectorAll("input");
      inputs.forEach(input => input.value = "");
      updateChart();
     });

    //*******************************************************************
    //Bouton actualiser
      document.getElementById('btnUpdate').addEventListener('click', () => {
      recalculerProjections();
      updateChart();
     });
    
    //*******************************************************************
    // Bouton enregistrement image en local
    document.getElementById('btnSaveBar').addEventListener('click', () => {
    const zone = document.getElementById('print-area');
    console.log('zone =', zone); // <--- important

      html2canvas(zone,).then(canvas => {
      const url = canvas.toDataURL("image/png");
      const a = document.createElement('a');
      a.href = url;
      a.download = generateUniqueFilename(); //generation du nom
      a.click();
      });

    });



   //*******************************************************************
   //Bouton envoyer un mail,
     document.getElementById('btnMail').addEventListener('click', () => {
      // genere image
     const zone = document.getElementById('chartWrapper');
     html2canvas(zone).then(canvas => {
     const base64Image = canvas.toDataURL("image/png").split(',')[1];
     const repo = "LAMARQUE40/graphique-mail";
     const path = generateUniqueFilename(); // chemin dans ton repo
     const branch = "main"; // ou master
     const token = "T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";

    fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Upload automatique de l'image",
        content: base64Image,
        branch: branch
      })
    })
    .then(res => res.json())
    .then(data => {
      //const rawUrl = data.content.download_url;
      console.log("Image envoyée sur GitHub :", data);
      alert("Image enregistrée sur GitHub !");
    })
    .catch(err => console.error(err));
  
      // fin image


      const { EvoCaGlobal, EvoCaLentilles } = recalculerProjections();
      const subject = encodeURIComponent('COOPERVISION - Simulation de l évolution de votre Chiffre d Affaires');  
      const body = encodeURIComponent(
        `Bonjour,\n\nVeuillez trouver les valeurs projetées de votre Chiffres d Affaires :
        \n- Evolution du chiffre d'affaires contactologie : ${fmtEuro(EvoCaLentilles)}
        \n- Evolution du chiffre d'affaires global du magasin : ${fmtEuro(EvoCaGlobal)}
        \n\nVoici le lien pour accéder à votre simulation :
        \n\nN'hésitez pas à revenir vers moi pour toute question.\n\nBien cordialement.`
        
       );
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
     });
});
   //*******************************************************************
   //fonctions,
     function fmtEuro(v){
       if (isNaN(v) || v === null) return '';
       const formatted = Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR', maximumFractionDigits:0 }).format(v);
       return (v > 0 ? "+ " : "") + formatted; 
       }
    
     function fmtPercent(v){
       if (isNaN(v) || v === null) return '';
       return new Intl.NumberFormat('fr-FR', { style:'percent', maximumFractionDigits:0 }).format(v);
       }

     function fmtEUR(v){ 
       try { return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v);} catch(e){ return v; }
       }

     function generateUniqueFilename() {
        const now = new Date();
        const timestamp = now.getFullYear()
        + String(now.getMonth() + 1).padStart(2, '0')
        + String(now.getDate()).padStart(2, '0')
        + "_"
        + String(now.getHours()).padStart(2, '0')
        + String(now.getMinutes()).padStart(2, '0')
        + String(now.getSeconds()).padStart(2, '0');
       return `Evolution_CA_${timestamp}.png`;
       }

     function recalculerProjections() {
       const caGlobal = parseFloat(document.getElementById('caGlobalActuel').value || '0');
       const caLens = parseFloat(document.getElementById('caLentillesActuel').value || '0');
       const pct = parseFloat(document.getElementById('objectifPct').value || '0');
       const caLensProjete = caGlobal * (pct/100)
       const caMagProjete = (caLensProjete - caLens) * 4 + caGlobal;
       const EvoCaGlobal = caMagProjete -caGlobal
       const EvoCaLentilles = caLensProjete-caLens
       document.getElementById('caGlobalProjete').value = fmtEuro(caMagProjete);
       document.getElementById('caLentillesProjete').value = fmtEuro(caLensProjete);
       document.getElementById('EvoCaGlobal').value = fmtEuro(EvoCaGlobal);
       document.getElementById('EvoCaLentilles').value = fmtEuro(EvoCaLentilles);
       return { caGlobal, caLens, caLensProjete, caMagProjete, EvoCaGlobal, EvoCaLentilles };
       }

     function computeProjections(){
        const G0 = parseFloat(document.getElementById('caGlobalActuel').value || '0');
        const L0 = parseFloat(document.getElementById('caLentillesActuel').value || '0');
        const tPct = parseFloat(document.getElementById('objectifPct').value || '0');
        const t = Math.max(0, tPct) / 100; 
        let L1 = t * G0;
        let G1 = (L1 - L0) * 4 + G0; 
        const EvoCaGlobal = G1 - G0
        const EvoCaLentilles = L1-L0
        return { G0, L0, G1, L1, EvoCaGlobal,EvoCaLentilles };
       }

      let barChart;

     function buildChart(){
        const ctx = document.getElementById('chart').getContext('2d');
        const { G0, L0, G1, L1 } = computeProjections();
        barChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Chiffre d Affaires Actuel', 'Chiffre d Affaires Projeté'],
            datasets: [
              { label:'CA Global', maxBarThickness: 70,   pointStyle:'circle', backgroundColor:'#1d4ed8', borderColor:'#0b3aa7', borderWidth:2, data:[G0, Number.isFinite(G1)?G1:0] },
              { label:'CA Lentilles', maxBarThickness: 70, pointStyle:'circle', backgroundColor:'#f59e0b', borderColor:'#c47400', borderWidth:2, data:[L0, Number.isFinite(L1)?L1:0] }
            ]
           },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 14, boxHeight: 14 } },
              datalabels: {
                anchor: 'end', align: 'end', offset: 4, color: '#111827', font: { weight: '700' },
                formatter: function(value) { return fmtEUR(value); }
              },
              tooltip: { callbacks: { label: function(ctx){ return ctx.dataset.label + ': ' + fmtEUR(ctx.parsed.y); } } }
            },
            scales: { y: { beginAtZero:true, ticks:{ callback:function(v){ return fmtEUR(v); } } }, x: { grid: { display:false } } }  
           }
         });
       }

      function updateChart(){
        const { G0, L0, G1, L1 } = computeProjections();
        const gEl=document.getElementById('caGlobalProjete'); 
        const lEl=document.getElementById('caLentillesProjete');
        if(gEl) gEl.value = Number.isFinite(G1)?fmtEUR(G1):''; if(lEl) lEl.value = Number.isFinite(L1)?fmtEUR(L1):'';
        if(barChart){ barChart.data.datasets[0].data=[G0, Number.isFinite(G1)?G1:0]; barChart.data.datasets[1].data=[L0, Number.isFinite(L1)?L1:0]; barChart.update(); }
       }
      
       //Calcul en auto 
      ['caGlobalActuel', 'caLentillesActuel', 'objectifPct'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
        recalculerProjections();
        updateChart();
       });
        });

       buildChart();

 
</script>
</body>
</html>

